<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js" %>
<%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" %>

<div class="wrapper">
    <div class="row" id="header">
        <%= render 'shared/header' %>
    </div>
    
    <div class="row">
      <div class="columns small-6 large-2">
        <div id="return" class="button export-button float-left">Voltar</div>
      </div>
      <div class="columns small-6 large-8">
        <div id=change_semester class="row">
            <div id="info_semester" class="text-center info-text">Histórico</div>
        </div>
      </div>
      <div class="columns small-12 large-2">
        <div id="historic_record" class="button export-button float-right">Atualizar Histórico</div>
      </div>
    </div>
        

    <div class="row">
        <ul id="blockTabs" class="tabs" data-tabs>
            <li id="historic" class="tabs-title is-active" aria-selected="true"><a href="#historic">Histórico</a></li>
        </ul>
    </div>

    <div class="row block tabs-content" data-tabs-content="blockTabs">
        <div id="historic" class="tabs-panel no-padding is-active">
            <div id="historic_show">
                <div class="row">
                    <div class="small-12 columns">
                        <%= render partial: 'historic_table', locals: { table_id: 'large_table_historic', table_class: 'historic-table unstriped large-table'} %>
                    </div>
                </div>
            </div>

            <div id="historic_insert" style="display:none">
                <div class="row" style="margin-bottom: 20px;">
                    <div id="handsontable" class="hot handsontable htRowHeaders htColumnHeaders"></div>
                </div>
            </div>
            
            <div class="row">
              <div class="small-12 columns">
                <span id="goToTop" class="go-to-top">▲ Topo</span>
              </div>
            </div>
        </div>
    </div>
    
</div>
<%= render 'shared/footer' %>

<% content_for :script do %>
<script>
    var historic_student = <%= raw @historic  %>;
    var step = 1;
    var inserted_historic = [];
    
    var $container = $("#handsontable");
    var handsontable = $container.data('handsontable');
    
    $("#goToTop").click(function() {
      $('html,body').animate({
          scrollTop: $("#header").offset().top
      }, 500);
    });
    
    function load_historic_inserted() {
        var historic_trated = [];
        var historic_semesters = [];
        
        var get_table_historic = $container.data('handsontable').getData();
        
        var last_semester = "";
        get_table_historic.forEach(function(x){
            if(x[0] != " "){
                last_semester = x[0];
                historic_semesters.push(x[0]);
            }
            if(x[1] != null){
                var obj_hystoric = {
                    semester_period: last_semester,
                    curricular_component: x[1] + " - " + x[2],
                    code: x[1],
                    name: x[2],
                    ch: x[3],
                    cr: x[4],
                    nt: x[5],
                    note: x[6],
                    res: x[7]
                };
                historic_trated.push(obj_hystoric);
            }
        });
        historic_trated = groupBy(historic_trated, 'semester_period');
        
        if(historic_semesters.length > 0){
            inserted_historic = [];
            historic_semesters.forEach(function(semester){
                var obj_inserted = {
                  semester: semester,
                  disciplines_historic: historic_trated[semester]
                };
                if(obj_inserted.semester != null && obj_inserted.disciplines_historic.length > 0){
                    inserted_historic.push(obj_inserted);
                }
            });
        }
        
        if(inserted_historic.length > 0){
            $("#large_table_historic tbody").empty();
            $("#large_table_historic tbody").append(get_result_table_history(inserted_historic));
        }
    }
    
    function load_historic() {
        if(historic_student.length > 0){
            $("#large_table_historic tbody").empty();
            $("#large_table_historic tbody").append(get_result_table_history(historic_student));    
        }
    }
    
    function load_handsontable() {
        var data = [];
        
        $container = $("#handsontable");
        handsontable = $container.data('handsontable');
        
        if(historic_student.length > 0){
            historic_student.forEach(function(x){
                var data_semester = [];
                var item_semester = x.semester;
                x.disciplines_historic.forEach(function(d){
                   item_row = [" ", d.code, d.name, (d.ch == 0 ? '--' : d.ch), (d.cr == 0 ? '--' : d.cr), d.nt, ((['TR', 'RF'].includes(d.res) ? '--' : d.note)), d.res] 
                   data_semester.push(item_row);
                });
                data_semester.push([]);
                data_semester[0][0] = x.semester;
                data = data.concat(data_semester);
            });
            data.push([]);
            
            //HANDSONTABLE
            var config = {
                data: data,
                preventOverflow: 'horizontal',
                startCols: 8,
                startRows: 10,
                className: "htCenter",
                rowHeaders: true,
                colHeaders: ['Período', 'Código', 'Disciplina', 'CH', 'CR', 'NT', 'Nota', 'RES'],
                licenseKey: "non-commercial-and-evaluation",
                colWidths: [80, 80, 645, 50, 50, 50, 50, 50],
                headerTooltips: {
                    rows: false,
                    columns: true,
                    onlyTrimmed: true
                }
            };
    
        }
        else {
            //HANDSONTABLE
            var config = {
            preventOverflow: 'horizontal',
            startCols: 8,
            startRows: 10,
            className: "htCenter",
            rowHeaders: true,
            colHeaders: ['Período', 'Código', 'Disciplina', 'CH', 'CR', 'NT', 'Nota', 'RES'],
            licenseKey: "non-commercial-and-evaluation",
            colWidths: [80, 80, 645, 50, 50, 50, 50, 50],
            headerTooltips: {
                rows: false,
                columns: true,
                onlyTrimmed: true
            }
            };
        }
    
        $("#handsontable").handsontable(config);
    }

    function complete_record() {
        historic_student = inserted_historic;
        $.ajax({
          url: "/historic",
          type: "post",
          data: {
              data_historic: JSON.stringify(historic_student)
          }
        });
    }
    
    $("#return").click(function() {
        step--;
        load_step();
    });
    
    $("#historic_record").click(function() {
        if($("#historic_record").text() === 'Concluir' && step == 3){
            complete_record();
        }
        else{
            step++;
            load_step();   
        }
    });
    
    load_step = function() {
        if(step == 1){
            load_historic();
            $("#historic_record").text('Atualizar Histórico');
            $("#historic_insert").hide();
            $("#historic_show").show();
        }
        else if (step == 2){
            load_handsontable();
            $("#historic_record").text('Próximo');
            $("#historic_show").hide();
            $("#historic_insert").show();
        }
        else if (step == 3){
            load_historic_inserted();
            $("#historic_record").text('Concluir');
            $("#historic_show").show();
            $("#historic_insert").hide();
        }
        step == 1 ? $("#return").css( {'visibility': 'hidden'}) : $("#return").css( {'visibility': 'visible'});
    }
    
    $(document).ready(function() {
        load_step();
    });
    
</script>
<% end %>